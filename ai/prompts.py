"""
Prompt æ¨¡æ¿ç®¡ç†
"""

from typing import Dict, List, Optional


class PromptTemplates:
    """Prompt æ¨¡æ¿é›†åˆ"""
    
    # å•ç¯‡æ–‡çŒ®æ€»ç»“
    SINGLE_PAPER_SUMMARY = """ä½ æ˜¯ä¸€ä½ä¸“ä¸šçš„å­¦æœ¯ç ”ç©¶åŠ©æ‰‹ã€‚è¯·å¯¹ä»¥ä¸‹å­¦æœ¯è®ºæ–‡è¿›è¡Œå…¨é¢è€Œæ·±å…¥çš„æ€»ç»“ã€‚

## è®ºæ–‡ä¿¡æ¯
- **æ ‡é¢˜**: {title}
- **ä½œè€…**: {authors}
- **å‘è¡¨æ—¥æœŸ**: {date}
- **æœŸåˆŠ/å‡ºç‰ˆç‰©**: {publication}

## æ‘˜è¦
{abstract}

## å…¨æ–‡å†…å®¹
{content}

---

è¯·æŒ‰ç…§ä»¥ä¸‹ç»“æ„è¿›è¡Œæ€»ç»“ï¼š

### 1. ç ”ç©¶èƒŒæ™¯ä¸åŠ¨æœº
- ç ”ç©¶çš„èƒŒæ™¯æ˜¯ä»€ä¹ˆï¼Ÿ
- è§£å†³ä»€ä¹ˆé—®é¢˜ï¼Ÿ
- ä¸ºä»€ä¹ˆè¿™ä¸ªé—®é¢˜é‡è¦ï¼Ÿ

### 2. æ ¸å¿ƒæ–¹æ³•
- ä½¿ç”¨äº†ä»€ä¹ˆæ–¹æ³•/æŠ€æœ¯ï¼Ÿ
- æ–¹æ³•çš„åˆ›æ–°ç‚¹æ˜¯ä»€ä¹ˆï¼Ÿ

### 3. ä¸»è¦å‘ç°ä¸ç»“æœ
- ä¸»è¦çš„å®éªŒç»“æœæ˜¯ä»€ä¹ˆï¼Ÿ
- å…³é”®çš„æ•°æ®æˆ–æŒ‡æ ‡

### 4. ç»“è®ºä¸è´¡çŒ®
- è®ºæ–‡çš„ä¸»è¦è´¡çŒ®æ˜¯ä»€ä¹ˆï¼Ÿ
- å¯¹é¢†åŸŸçš„å½±å“

### 5. å±€é™æ€§ä¸æœªæ¥æ–¹å‘
- ç ”ç©¶çš„å±€é™æ€§
- å¯èƒ½çš„æœªæ¥ç ”ç©¶æ–¹å‘

### 6. å…³é”®è¯å’Œä¸»é¢˜
- åˆ—å‡º3-5ä¸ªå…³é”®è¯
- è®ºæ–‡æ¶‰åŠçš„ä¸»è¦ä¸»é¢˜é¢†åŸŸ

è¯·ç”¨æ¸…æ™°ã€ä¸“ä¸šçš„å­¦æœ¯è¯­è¨€è¿›è¡Œæ€»ç»“ï¼Œæ§åˆ¶åœ¨800-1200å­—å·¦å³ã€‚"""

    # å¤šç¯‡æ–‡çŒ®ç»¼åˆåˆ†æ
    MULTI_PAPER_SYNTHESIS = """ä½ æ˜¯ä¸€ä½ä¸“ä¸šçš„å­¦æœ¯ç ”ç©¶åŠ©æ‰‹ã€‚è¯·å¯¹ä»¥ä¸‹å¤šç¯‡ç›¸å…³å­¦æœ¯è®ºæ–‡è¿›è¡Œç»¼åˆåˆ†æå’Œå¯¹æ¯”ã€‚

## æ–‡çŒ®åˆ—è¡¨

{papers_list}

---

**è¾“å‡ºè¦æ±‚**ï¼š
- ä½¿ç”¨ Markdown æ ¼å¼è¾“å‡ºï¼ŒåŒ…æ‹¬æ ‡é¢˜ã€åˆ—è¡¨ã€åŠ ç²—ç­‰
- å¼•ç”¨æ–‡çŒ®æ—¶ä½¿ç”¨ã€Œç¼©å†™å†™åã€ï¼ˆå¦‚ "Alphafold2", "AF2"ï¼‰æˆ–ã€Œå®Œæ•´æ ‡é¢˜ã€ï¼Œä¸è¦ä½¿ç”¨â€œè®ºæ–‡1ã€è®ºæ–‡2â€ç­‰ç¼–å·
- ä½¿ç”¨è¡¨æ ¼ã€åˆ—è¡¨ç­‰å¢å¼ºå¯è¯»æ€§

è¯·æŒ‰ç…§ä»¥ä¸‹ç»“æ„è¿›è¡Œç»¼åˆåˆ†æï¼š

### 1. ğŸ¯ ä¸»é¢˜æ¦‚è¿°
- è¿™äº›è®ºæ–‡å…±åŒå…³æ³¨çš„ç ”ç©¶é¢†åŸŸ/é—®é¢˜æ˜¯ä»€ä¹ˆï¼Ÿ
- ç ”ç©¶çš„æ•´ä½“èƒŒæ™¯

### 2. ğŸ”¬ æ–¹æ³•å¯¹æ¯”
- å„è®ºæ–‡ä½¿ç”¨çš„æ–¹æ³•æœ‰ä½•å¼‚åŒï¼Ÿ
- æ–¹æ³•è®ºä¸Šçš„æ¼”è¿›æˆ–åˆ›æ–°

### 3. ğŸ“Š å‘ç°ä¸ç»“è®ºå¯¹æ¯”
- å„è®ºæ–‡çš„ä¸»è¦å‘ç°
- ç»“è®ºä¹‹é—´æ˜¯å¦æœ‰ä¸€è‡´æ€§æˆ–çŸ›ç›¾ï¼Ÿ

### 4. ğŸ“ˆ ç ”ç©¶è¶‹åŠ¿
- ä»è¿™äº›è®ºæ–‡ä¸­å¯ä»¥çœ‹å‡ºä»€ä¹ˆç ”ç©¶è¶‹åŠ¿ï¼Ÿ
- è¯¥é¢†åŸŸçš„å‘å±•æ–¹å‘

### 5. ğŸ” çŸ¥è¯†ç¼ºå£ä¸æœºä¼š
- ç°æœ‰ç ”ç©¶çš„ä¸è¶³
- æ½œåœ¨çš„ç ”ç©¶æœºä¼š

### 6. âœ… ç»¼åˆç»“è®º
- å¯¹è¿™ç»„æ–‡çŒ®çš„æ•´ä½“è¯„ä»·
- å¯¹åç»­ç ”ç©¶çš„å»ºè®®

è¯·æä¾›æ·±å…¥ã€æœ‰æ´å¯ŸåŠ›çš„åˆ†æï¼Œæ§åˆ¶åœ¨1500-2000å­—ã€‚"""

    # Deep Research æ·±åº¦ç ”ç©¶
    DEEP_RESEARCH = """ä½ æ˜¯ä¸€ä½èµ„æ·±çš„å­¦æœ¯ç ”ç©¶ä¸“å®¶ï¼Œæ“…é•¿è¿›è¡Œæ·±åº¦æ–‡çŒ®ç ”ç©¶å’ŒçŸ¥è¯†ç»¼åˆã€‚

## ç ”ç©¶é—®é¢˜
{research_question}

## ç›¸å…³æ–‡çŒ®èµ„æ–™

{literature_content}

---

è¯·è¿›è¡Œæ·±åº¦ç ”ç©¶åˆ†æï¼ŒæŒ‰ä»¥ä¸‹ç»“æ„è¾“å‡ºç ”ç©¶æŠ¥å‘Šï¼š

# æ·±åº¦ç ”ç©¶æŠ¥å‘Š

## æ‰§è¡Œæ‘˜è¦
- ç ”ç©¶é—®é¢˜çš„ç®€è¦å›ç­”
- ä¸»è¦å‘ç°æ¦‚è¿°

## 1. ç ”ç©¶èƒŒæ™¯
- é—®é¢˜çš„é‡è¦æ€§
- å½“å‰ç ”ç©¶ç°çŠ¶æ¦‚è¿°

## 2. æ–‡çŒ®åˆ†æ

### 2.1 ç†è®ºæ¡†æ¶
- ä¸»è¦ç†è®ºå’Œæ¦‚å¿µ
- ç†è®ºçš„æ¼”è¿›

### 2.2 æ–¹æ³•è®ºç»¼è¿°
- å¸¸ç”¨ç ”ç©¶æ–¹æ³•
- æ–¹æ³•çš„ä¼˜ç¼ºç‚¹

### 2.3 å®è¯å‘ç°
- å…³é”®å®è¯ç»“æœ
- è¯æ®çš„ä¸€è‡´æ€§åˆ†æ

## 3. æ‰¹åˆ¤æ€§åˆ†æ
- ç°æœ‰ç ”ç©¶çš„ä¼˜åŠ¿
- ç ”ç©¶çš„å±€é™å’Œä¸è¶³
- å­˜åœ¨çš„äº‰è®®æˆ–åˆ†æ­§

## 4. çŸ¥è¯†å›¾è°±
- æ ¸å¿ƒæ¦‚å¿µä¹‹é—´çš„å…³ç³»
- ç ”ç©¶ä¸»é¢˜çš„åˆ†ç±»

## 5. ç ”ç©¶è¶‹åŠ¿ä¸å±•æœ›
- æ–°å…´ç ”ç©¶æ–¹å‘
- æœªæ¥ç ”ç©¶å»ºè®®
- æ½œåœ¨çš„çªç ´é¢†åŸŸ

## 6. ç»“è®º
- å…³é”®æ´å¯Ÿæ€»ç»“
- å®è·µå»ºè®®

## å‚è€ƒæ–‡çŒ®æ‘˜è¦
- å¼•ç”¨çš„å…³é”®æ–‡çŒ®åˆ—è¡¨

è¯·æä¾›å…¨é¢ã€æ·±å…¥ã€æœ‰å­¦æœ¯ä»·å€¼çš„ç ”ç©¶æŠ¥å‘Šï¼Œå­—æ•°åœ¨2000-3000å­—ä¹‹é—´ã€‚"""

    # å¿«é€Ÿæ‘˜è¦
    QUICK_SUMMARY = """è¯·ç”¨2-3å¥è¯ç®€æ´åœ°æ€»ç»“ä»¥ä¸‹è®ºæ–‡çš„æ ¸å¿ƒå†…å®¹ï¼š

æ ‡é¢˜: {title}
ä½œè€…: {authors}
æ‘˜è¦: {abstract}

å†…å®¹ç‰‡æ®µ: {content_snippet}

è¯·ç›´æ¥ç»™å‡ºç®€æ´çš„æ€»ç»“ï¼Œä¸éœ€è¦æ ‡é¢˜æˆ–æ ¼å¼ã€‚"""

    # å…³é”®ç‚¹æå–
    KEY_POINTS = """è¯·ä»ä»¥ä¸‹è®ºæ–‡ä¸­æå–5-7ä¸ªå…³é”®è¦ç‚¹ï¼š

æ ‡é¢˜: {title}
å†…å®¹: {content}

è¯·ä»¥ç®€æ´çš„è¦ç‚¹å½¢å¼è¾“å‡ºï¼Œæ¯ä¸ªè¦ç‚¹ç”¨ä¸€å¥è¯æ¦‚æ‹¬ã€‚"""

    # ç ”ç©¶é—®é¢˜ç”Ÿæˆ
    RESEARCH_QUESTIONS = """åŸºäºä»¥ä¸‹æ–‡çŒ®å†…å®¹ï¼Œç”Ÿæˆ3-5ä¸ªå€¼å¾—è¿›ä¸€æ­¥ç ”ç©¶çš„é—®é¢˜ï¼š

{content}

è¯·åˆ—å‡ºå…·æœ‰ç ”ç©¶ä»·å€¼çš„é—®é¢˜ï¼Œæ¯ä¸ªé—®é¢˜åº”è¯¥ï¼š
1. å…·ä½“ä¸”å¯æ“ä½œ
2. ä¸ç°æœ‰æ–‡çŒ®ç›¸å…³ä½†å°šæœªå……åˆ†è§£ç­”
3. å…·æœ‰å­¦æœ¯æˆ–å®è·µä»·å€¼"""

    # å¿«é€Ÿåˆ†ç±»æ±‡æ€»ï¼ˆä»…ä½¿ç”¨æ‘˜è¦ï¼‰
    QUICK_CATEGORIZE = """ä½ æ˜¯ä¸€ä½ä¸“ä¸šçš„å­¦æœ¯ç ”ç©¶åŠ©æ‰‹ã€‚è¯·æ ¹æ®ä»¥ä¸‹å¤šç¯‡è®ºæ–‡çš„æ‘˜è¦ä¿¡æ¯ï¼Œå¯¹è¿™äº›æ–‡çŒ®è¿›è¡Œæ™ºèƒ½åˆ†ç±»å’Œæ±‡æ€»åˆ†æã€‚

## æ–‡çŒ®æ‘˜è¦åˆ—è¡¨

{abstracts_list}

---

**è¾“å‡ºè¦æ±‚**ï¼š
- ä½¿ç”¨ Markdown æ ¼å¼ï¼ŒåŒ…æ‹¬æ ‡é¢˜ã€è¡¨æ ¼ã€åˆ—è¡¨ã€emoji ç­‰
- å¼•ç”¨æ–‡çŒ®æ—¶ä½¿ç”¨ã€Œç¬¬ä¸€ä½œè€…å§“æ° + et al. + å¹´ä»½ã€ï¼ˆå¦‚ "Smith et al., 2023"ï¼‰æˆ–ã€Œæ ‡é¢˜ç¼©å†™ã€ï¼ˆå–æ ‡é¢˜å‰3-5ä¸ªå…³é”®è¯ï¼‰
- **ç»å¯¹ä¸è¦ä½¿ç”¨â€œè®ºæ–‡1ã€è®ºæ–‡2ã€è®ºæ–‡3â€ç­‰ç¼–å·å¼•ç”¨**
- ä½¿ç”¨å›¾ä¾‹å’Œå¯è§†åŒ–å…ƒç´ å¢å¼ºå¯è¯»æ€§

è¯·æŒ‰ç…§ä»¥ä¸‹ç»“æ„è¿›è¡Œåˆ†æå’Œè¾“å‡ºï¼š

# ğŸ“Š æ–‡çŒ®åˆ†ç±»æ±‡æ€»æŠ¥å‘Š

## 1ï¸âƒ£ ä¸»é¢˜åˆ†ç±»

å°†è¿™äº›æ–‡çŒ®æŒ‰ç ”ç©¶ä¸»é¢˜/æ–¹å‘åˆ†æˆè‹¥å¹²ç±»åˆ«ï¼Œæ¯ä¸ªç±»åˆ«åŒ…å«ï¼š

### ğŸŸ¢ [ç±»åˆ«åç§°]
- **ä»£è¡¨æ–‡çŒ®**ï¼š
  - Author1 et al. (2023): â€œæ ‡é¢˜ç¼©å†™æˆ–å…³é”®è¯â€
  - Author2 et al. (2022): â€œæ ‡é¢˜ç¼©å†™æˆ–å…³é”®è¯â€
- **ä¸»é¢˜ç‰¹ç‚¹**ï¼šè¯¥ç±»åˆ«æ–‡çŒ®çš„å…±åŒç‰¹ç‚¹ï¼ˆ1-2å¥è¯ï¼‰

### ğŸŸ¡ [å¦ä¸€ç±»åˆ«åç§°]
...
---

## 2ï¸âƒ£ æ–¹æ³•è®ºåˆ†ç±»

| æ–¹æ³•ç±»å‹ | ä»£è¡¨æ–‡çŒ® | ç‰¹ç‚¹ |
|---------|---------|-----|
| ğŸ“š ç†è®ºç ”ç©¶ | Author et al. (2023), ... | ... |
| ğŸ“Š å®è¯ç ”ç©¶ | Author et al. (2022), ... | ... |
| ğŸ“ ç»¼è¿°åˆ†æ | Author et al. (2021), ... | ... |

---

## 3ï¸âƒ£ æ•´ä½“æ¦‚è¿°

ğŸ¯ **ç ”ç©¶é¢†åŸŸ**ï¼š...

ğŸ”‘ **ä¸»è¦å…³æ³¨ç‚¹**ï¼š...

---

## 4ï¸âƒ£ ç ”ç©¶è¶‹åŠ¿ä¸æ–¹å‘

```mermaid
graph LR
    A[æ—©æœŸç ”ç©¶] --> B[å½“å‰çƒ­ç‚¹]
    B --> C[æ–°å…´æ–¹å‘]
```

- ğŸ“ˆ **ä¸»è¦è¶‹åŠ¿**ï¼š...
- âœ¨ **æ–°å…´æ–¹å‘**ï¼š...

---

## 5ï¸âƒ£ çŸ¥è¯†å›¾è°±

```
æ ¸å¿ƒä¸»é¢˜
    â”œâ”€â”€ åˆ†æ”¯1: Author1 et al. (2023), Author2 et al. (2022)
    â”œâ”€â”€ åˆ†æ”¯2: Author3 et al. (2021)
    â””â”€â”€ åˆ†æ”¯3: Author4 et al. (2020)
```

---

## ğŸ’¡ å…³é”®æ´å¯Ÿ

> ç”¨ 2-3 å¥è¯æ€»ç»“æœ€é‡è¦çš„å‘ç°å’Œè§è§£

è¯·ç¡®ä¿åˆ†ææ¸…æ™°ã€ä¸“ä¸šï¼Œçªå‡ºæ–‡çŒ®ä¹‹é—´çš„è”ç³»å’Œå·®å¼‚ã€‚"""

    @classmethod
    def get_single_summary_prompt(
        cls,
        title: str,
        authors: str,
        date: Optional[str],
        publication: Optional[str],
        abstract: Optional[str],
        content: str
    ) -> str:
        """ç”Ÿæˆå•ç¯‡è®ºæ–‡æ€»ç»“ prompt"""
        return cls.SINGLE_PAPER_SUMMARY.format(
            title=title,
            authors=authors,
            date=date or "æœªçŸ¥",
            publication=publication or "æœªçŸ¥",
            abstract=abstract or "æ— æ‘˜è¦",
            content=content[:15000]  # é™åˆ¶é•¿åº¦
        )
    
    @classmethod
    def get_multi_paper_prompt(cls, papers: List[Dict]) -> str:
        """ç”Ÿæˆå¤šç¯‡è®ºæ–‡ç»¼åˆåˆ†æ prompt"""
        papers_text = []
        for i, paper in enumerate(papers, 1):
            # ç”Ÿæˆæ–‡çŒ®å¼•ç”¨åï¼šä½œè€… et al. (year)
            authors = paper.get('authors', '') or 'æœªçŸ¥'
            # å®‰å…¨åœ°æå–ç¬¬ä¸€ä½œè€…
            if authors and authors != 'æœªçŸ¥':
                try:
                    author_parts = authors.replace(';', ',').split(',')[0].strip()
                    first_author = author_parts.split()[-1] if author_parts else 'æœªçŸ¥'
                except Exception:
                    first_author = 'æœªçŸ¥'
            else:
                first_author = 'æœªçŸ¥'
                
            date_str = paper.get('date', '') or ''
            year = date_str[:4] if date_str and len(date_str) >= 4 else 'æœªçŸ¥'
            citation = f"{first_author} et al. ({year})"
            
            paper_text = f"""
### ğŸ“ {citation}: {paper.get('title', '') or 'æœªçŸ¥æ ‡é¢˜'}
- **ä½œè€…**: {authors}
- **æ‘˜è¦**: {paper.get('abstract', '') or 'æ— æ‘˜è¦'}
- **å…³é”®å†…å®¹**: {(paper.get('content', '') or '')[:3000]}
"""
            papers_text.append(paper_text)
        
        return cls.MULTI_PAPER_SYNTHESIS.format(
            papers_list="\n".join(papers_text)
        )
    
    @classmethod
    def get_deep_research_prompt(
        cls,
        research_question: str,
        literature_content: str
    ) -> str:
        """ç”Ÿæˆæ·±åº¦ç ”ç©¶ prompt"""
        return cls.DEEP_RESEARCH.format(
            research_question=research_question,
            literature_content=literature_content[:20000]
        )
    
    @classmethod
    def get_quick_summary_prompt(
        cls,
        title: str,
        authors: str,
        abstract: Optional[str],
        content_snippet: str
    ) -> str:
        """ç”Ÿæˆå¿«é€Ÿæ‘˜è¦ prompt"""
        return cls.QUICK_SUMMARY.format(
            title=title,
            authors=authors,
            abstract=abstract or "æ— æ‘˜è¦",
            content_snippet=content_snippet[:2000]
        )
    
    @classmethod
    def get_quick_categorize_prompt(cls, papers: List[Dict]) -> str:
        """ç”Ÿæˆå¿«é€Ÿåˆ†ç±»æ±‡æ€» promptï¼ˆä»…ä½¿ç”¨æ‘˜è¦ï¼‰"""
        abstracts_text = []
        for i, paper in enumerate(papers, 1):
            # ç”Ÿæˆæ–‡çŒ®å¼•ç”¨åï¼šä½œè€… et al. (year)
            authors = paper.get('authors', '') or 'æœªçŸ¥'
            # å®‰å…¨åœ°æå–ç¬¬ä¸€ä½œè€…
            if authors and authors != 'æœªçŸ¥':
                try:
                    # æŒ‰é€—å·æˆ–åˆ†å·åˆ†å‰²ï¼Œç„¶åå–æœ€åä¸€ä¸ªå•è¯ä½œä¸ºå§“æ°
                    author_parts = authors.replace(';', ',').split(',')[0].strip()
                    first_author = author_parts.split()[-1] if author_parts else 'æœªçŸ¥'
                except Exception:
                    first_author = 'æœªçŸ¥'
            else:
                first_author = 'æœªçŸ¥'
            
            date_str = paper.get('date', '') or ''
            year = date_str[:4] if date_str and len(date_str) >= 4 else 'æœªçŸ¥'
            citation = f"{first_author} et al. ({year})"
            
            # ç”Ÿæˆæ ‡é¢˜ç¼©å†™ï¼ˆå–å‰3-5ä¸ªå…³é”®è¯ï¼‰
            title = paper.get('title', '') or 'æœªçŸ¥æ ‡é¢˜'
            try:
                title_words = [w for w in title.split() if len(w) > 3][:5]
                title_abbr = ' '.join(title_words) if title_words else title[:50]
            except Exception:
                title_abbr = title[:50]
            
            abstract_text = f"""
### ğŸ“ {citation}
- **å®Œæ•´æ ‡é¢˜**: {title}
- **ç¼©å†™å¼•ç”¨**: "{title_abbr}"
- **ä½œè€…**: {authors}
- **å‘è¡¨æ—¶é—´**: {paper.get('date', '') or 'æœªçŸ¥'}
- **æœŸåˆŠ/ä¼šè®®**: {paper.get('publication', '') or 'æœªçŸ¥'}
- **æ‘˜è¦**: {paper.get('abstract', '') or 'æ— æ‘˜è¦'}
"""
            abstracts_text.append(abstract_text)
        
        return cls.QUICK_CATEGORIZE.format(
            abstracts_list="\n".join(abstracts_text)
        )
